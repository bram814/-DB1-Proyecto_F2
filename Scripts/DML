
/**  CONSULTA 1
 * Dar el nombre del estudiante, promedio, y número de créditos ganados, para los
 * estudiantes que han cerrado Ingeniería en Ciencias y Sistemas.
*/
SELECT e.nombre as nombre, AVG(a.nota) as promedio, SUM(p.numcreditos) as  creditos FROM asignacion a
    INNER JOIN estudiante e ON e.carnet = a.carnet
    INNER JOIN pensum p ON p.codigo = a.codigo
    INNER JOIN carrera c ON c.carrera = p.carrera
    INNER JOIN curso cu on a.codigo = cu.codigo
WHERE c.carrera = '6' 
group by e.nombre 
HAVING SUM(p.numcreditos) = 141;


/**  CONSULTA 2
 * Dar el nombre del estudiante nombre de la carrera, promedio y número de créditos
 * ganados, para los estudiantes que han cerrado en alguna carrera, estén inscritos en ella o
 * no.
*/
SELECT e.nombre as nombre, ca.nombre as carrera, TRUNC(AVG(a.nota),2) as promedio, sum(pe.numcreditos) as creditos
    FROM Asignacion a
        INNER JOIN estudiante e ON e.carnet = a.carnet
        INNER JOIN seccion se on se.codigo = a.codigo and se.ano = a.ano and se.ciclo = a.ciclo and se.seccion = a.seccion
        INNER JOIN inscrito ins on ins.carnet = a.carnet
        INNER JOIN carrera ca on ca.carrera = ins.carrera
        INNER JOIN plan pl on pl.carrera = ca.carrera
        INNER JOIN Pensum pe on pe.codigo = a.codigo and pe.plan = pl.plan and pe.carrera = ca.carrera
group by e.nombre, ca.nombre
HAVING sum(pe.numcreditos) = 141
order by ca.nombre;
/**  CONSULTA 3
 * Dar el nombre del estudiante nombre de la carrera, promedio y número de créditos
 * ganados, para los estudiantes que han cerrado en alguna carrera, estén inscritos en ella o
 * no.
*/
SELECT cat.nombre as catedratico, cur.nombre as curso, e.nombre as estudiante
    FROM seccion se
        INNER JOIN catedratico cat on cat.catedratico = se.catedratico
        INNER JOIN curso cur on  cur.codigo = se.codigo
        INNER JOIN pensum pe on pe.codigo = cur.codigo  
        INNER JOIN asignacion a on a.codigo = cur.codigo AND a.seccion = se.seccion AND a.ciclo = se.ciclo
        INNER JOIN estudiante e on e.carnet = a.carnet
        
group by cat.nombre, cur.nombre, e.nombre
order by cat.nombre, cur.nombre, e.nombre;

-- con catedratico en especifico.
SELECT cat.nombre as catedratico, cur.nombre as curso, e.nombre as estudiante
    FROM seccion se
        INNER JOIN catedratico cat on cat.catedratico = se.catedratico
        INNER JOIN curso cur on  cur.codigo = se.codigo
        INNER JOIN pensum pe on pe.codigo = cur.codigo  
        INNER JOIN asignacion a on a.codigo = cur.codigo AND a.seccion = se.seccion AND a.ciclo = se.ciclo
        INNER JOIN estudiante e on e.carnet = a.carnet
where cat.nombre = 'Amye Manoch'        
group by cat.nombre, cur.nombre, e.nombre
order by cat.nombre, cur.nombre, e.nombre;

/** CONSULTA 4
 * 4. Para un estudiante determinado que cerrado en alguna carrera, dar el nombre de los
 * estudiantes que llevaron con él todos los cursos.
*/

select DISTINCT s3.compañero, es.nombre from (
    select  compañero from (
        select * from 
        (
            (
            select a.carnet, a.seccion, a.ano, a.ciclo, a.codigo, cur.nombre from asignacion a
                INNER JOIN seccion sec on sec.seccion = a.seccion and a.ano = sec.ano and a.codigo = sec.codigo and a.ciclo = sec.ciclo
                INNER JOIN curso cur on cur.codigo = sec.codigo and cur.codigo = a.codigo
                
            where a.carnet = '201800937'
            order by a.seccion, a.ano, a.ciclo
            
            ) s1
           JOIN 
           (
              select a.carnet as compañero, a.seccion, a.ano, a.ciclo, a.codigo from asignacion a
                INNER JOIN seccion sec on sec.seccion = a.seccion and a.ano = sec.ano and a.codigo = sec.codigo and a.ciclo = sec.ciclo
                INNER JOIN curso cur on cur.codigo = sec.codigo and cur.codigo = a.codigo
                
            where a.carnet <> '201800937'
            order by a.seccion, a.ano, a.ciclo
            
           ) s2
           on (s1.seccion = s2.seccion and s1.ano = s2.ano and s1.ciclo = s2.ciclo)
        )
    )
) s3 
INNER JOIN estudiante es on s3.compañero = es.carnet;

/** CONSULTA 5
 * Dar el nombre de las parejas de estudiantes que han llevado todos los cursos en común (es
 * decir, han sido compañeros en todos los cursos).
*/
select DISTINCT s3.compañero, es.nombre from (
    select  persona,compañero, s2seccion, s2ano,s2ciclo, s2codigo from (
        select persona,compañero, s2seccion, s2ano, s2ciclo, s2codigo  from 
        (
            (
                select a.carnet as persona, a.seccion, a.ano, a.ciclo, a.codigo, cur.nombre from asignacion a
                    INNER JOIN seccion sec on sec.seccion = a.seccion and a.ano = sec.ano and a.codigo = sec.codigo and a.ciclo = sec.ciclo
                    INNER JOIN curso cur on cur.codigo = sec.codigo and cur.codigo = a.codigo
                    
                where a.carnet = '201800937'
                order by a.seccion, a.ano, a.ciclo
            
            ) s1
           JOIN 
           (
              select a.carnet as compañero, a.seccion as s2seccion, a.ano as s2ano, a.ciclo as s2ciclo, a.codigo as s2codigo  from asignacion a
                INNER JOIN seccion sec on sec.seccion = a.seccion and a.ano = sec.ano and a.codigo = sec.codigo and a.ciclo = sec.ciclo
                INNER JOIN curso cur on cur.codigo = sec.codigo and cur.codigo = a.codigo
                
            where a.carnet <> '201800937'
            order by a.seccion, a.ano, a.ciclo
            
           ) s2
           on (s1.seccion = s2seccion and s1.ano = s2ano and s1.ciclo = s2ciclo and s1.codigo = s2codigo )
        ) 
    ) 
) s3
INNER JOIN estudiante es on s3.compañero = es.carnet
INNER JOIN inscrito ins on es.carnet = ins.carnet
INNER JOIN inscrito ins2 on s3.persona =  ins2.carnet
INNER JOIN carrera car on car.carrera = ins.carrera and ins2.carrera = ins.carrera

where 
    (
        select * from
            (
                select count(*) as rcont1 from asignacion a
                    INNER JOIN estudiante es on es.carnet = a.carnet
                    INNER JOIN inscrito ins on ins.carnet = es.carnet
                where a.carnet = s3.persona
            ) s1cont
            JOIN
            (
                select count(*) as rcont2 from asignacion a
                    INNER JOIN estudiante es on es.carnet = a.carnet
                    INNER JOIN inscrito ins on ins.carnet = es.carnet
                where a.carnet = s3.compañero
            ) s2cont
            on (s1cont.rcont1 = s2cont.rcont2)

    )
;